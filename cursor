#!/bin/bash

# Cursor command wrapper for Frenchie Care deployment
# Usage: ./cursor [command]

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

show_help() {
    echo -e "${BLUE}Frenchie Care Deployment Commands${NC}"
    echo ""
    echo "Usage: ./cursor [command]"
    echo ""
    echo "Commands:"
    echo "  deploy-local    Sync GitHub repo to local WordPress (themes, plugins, content)"
    echo "  reset-local     Wipe and re-import all content from repo (fresh install)"
    echo "  configure       Configure WordPress settings (permalinks, plugins, etc.)"
    echo "  setup-hooks     Enable automatic deployment on git pull/checkout"
    echo "  status          Check deployment status and Local site health"
    echo "  help            Show this help message"
    echo ""
    echo "Examples:"
    echo "  ./cursor deploy-local   # Update local site with latest from GitHub"
    echo "  ./cursor reset-local    # Complete reset and fresh import"
    echo "  ./cursor setup-hooks    # Enable auto-deploy on git operations"
}

check_status() {
    echo -e "${BLUE}=== Deployment Status Check ===${NC}\n"
    
    # Check git status
    echo -e "${YELLOW}Git Repository:${NC}"
    cd "$SCRIPT_DIR"
    current_branch=$(git branch --show-current)
    echo "Current branch: $current_branch"
    
    # Check if up to date
    git fetch origin >/dev/null 2>&1
    LOCAL=$(git rev-parse @)
    REMOTE=$(git rev-parse @{u})
    if [ "$LOCAL" = "$REMOTE" ]; then
        echo -e "${GREEN}✓ Repository is up to date${NC}"
    else
        echo -e "${RED}✗ Repository needs update (run deploy-local)${NC}"
    fi
    
    # Check Local site
    echo -e "\n${YELLOW}Local by Flywheel Site:${NC}"
    LOCAL_SITE_PATH="$HOME/Local Sites/frenchie-allergy-help/app/public"
    if [ -d "$LOCAL_SITE_PATH" ]; then
        echo -e "${GREEN}✓ Site directory exists${NC}"
        
        # Check if site is running
        response=$(curl -s -o /dev/null -w "%{http_code}" "http://frenchie-allergy-help.local" 2>/dev/null || echo "000")
        if [ "$response" = "200" ]; then
            echo -e "${GREEN}✓ Site is running${NC}"
        else
            echo -e "${RED}✗ Site is not accessible (start Local by Flywheel)${NC}"
        fi
        
        # Check theme
        if [ -d "$LOCAL_SITE_PATH/wp-content/themes/frenchie-care" ]; then
            echo -e "${GREEN}✓ Frenchie Care theme installed${NC}"
        else
            echo -e "${RED}✗ Theme not found${NC}"
        fi
        
        # Check plugins
        echo -e "\n${YELLOW}Plugins:${NC}"
        for plugin in "frenchie-email-automation" "frenchie-monetization"; do
            if [ -d "$LOCAL_SITE_PATH/wp-content/plugins/$plugin" ]; then
                echo -e "${GREEN}✓ $plugin installed${NC}"
            else
                echo -e "${RED}✗ $plugin not found${NC}"
            fi
        done
    else
        echo -e "${RED}✗ Local site not found${NC}"
        echo "Please create a site named 'frenchie-allergy-help' in Local by Flywheel"
    fi
}

# Main command handler
case "$1" in
    deploy-local)
        "$SCRIPT_DIR/scripts/deploy-local.sh"
        ;;
    reset-local)
        "$SCRIPT_DIR/scripts/reset-local.sh"
        ;;
    configure)
        "$SCRIPT_DIR/scripts/configure-wordpress.sh"
        ;;
    setup-hooks)
        "$SCRIPT_DIR/scripts/setup-git-hooks.sh"
        ;;
    status)
        check_status
        ;;
    help|"")
        show_help
        ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        show_help
        exit 1
        ;;
esac